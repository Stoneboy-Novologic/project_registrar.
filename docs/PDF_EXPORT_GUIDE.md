# PDF Export Implementation Guide

## Overview

The PDF export feature allows users to export construction reports as professional PDF documents with customizable layouts, watermarks, branding, headers, footers, and page numbering.

## Features

### 1. PDF Generation with Playwright
- Uses Playwright's Chromium browser for high-quality PDF generation
- Supports A4 and Letter page sizes
- Portrait and landscape orientations
- Customizable margins and page breaks

### 2. Print-Friendly Layouts
- Optimized CSS for printing
- Proper page break controls
- Print-optimized colors and fonts
- Responsive layout preservation

### 3. Watermarks and Branding
- Configurable "CONFIDENTIAL" watermark
- Company name, logo, and footer text
- Customizable via environment variables or code

### 4. Page Numbering
- Automatic page numbering (Page X of Y)
- Displayed in footer
- Updates automatically for multi-page reports

### 5. Headers and Footers
- Report name and date in header
- Company information and copyright in footer
- Category-specific templates

### 6. Custom PDF Templates
- Different layouts per report category:
  - **Project Documentation**: Standard layout with company header
  - **Financial**: Financial layout with watermark
  - **Technical**: Technical layout with page numbers
  - **Safety**: Safety report layout with compliance badges
  - **Quality Control**: Quality layout with approval sections

## Usage

### Exporting a Report

1. **Via UI**:
   - Load a report in the editor
   - Click the "Export PDF" button in the toolbar
   - Configure export options:
     - Select pages (all or specific pages)
     - Toggle watermark
     - Toggle branding
   - Click "Export PDF"
   - PDF will download automatically

2. **Via API**:
```bash
GET /api/reports/[id]/export/pdf?includeWatermark=true&includeBranding=true&pages=pageId1,pageId2
```

### Query Parameters

- `includeWatermark` (optional): `true` to include watermark, default: `false`
- `includeBranding` (optional): `false` to exclude branding, default: `true`
- `pages` (optional): Comma-separated list of page IDs to export, default: all pages

## Configuration

### Environment Variables

Create or update `.env.local`:

```env
# PDF Branding Configuration
PDF_COMPANY_NAME=BharatERP
PDF_COMPANY_LOGO_URL=/logo.png
PDF_WATERMARK_TEXT=CONFIDENTIAL
PDF_FOOTER_TEXT=Generated by BharatERP Construction Report System
PDF_COPYRIGHT_TEXT=© 2025 BharatERP. All rights reserved.

# PDF Storage (optional, for future persistent storage)
PDF_STORAGE_PATH=/tmp/pdf-exports
PDF_STORAGE_URL=https://your-domain.com/pdf-exports
```

### Branding Configuration

Edit `lib/config/branding.ts` to customize default branding:

```typescript
export function getBrandingConfig(): BrandingConfig {
  return {
    companyName: "Your Company Name",
    companyLogoUrl: "/path/to/logo.png",
    watermarkText: "CONFIDENTIAL",
    footerText: "Your custom footer text",
    copyrightText: "© 2025 Your Company. All rights reserved."
  };
}
```

### PDF Templates

Edit `lib/services/pdf-templates.ts` to customize PDF layouts per category:

```typescript
export function getPDFTemplate(category: string, branding: BrandingConfig): PDFTemplate {
  // Customize template for specific category
  const templates: Record<string, PDFTemplate> = {
    "your-category": {
      name: "Your Template",
      category: "your-category",
      pageSize: "A4",
      orientation: "portrait",
      margins: { top: "2cm", right: "1.5cm", bottom: "2cm", left: "1.5cm" },
      // ... more options
    }
  };
  // ...
}
```

## Architecture

### File Structure

```
lib/
  config/
    branding.ts                 # Branding configuration
  services/
    pdf-generator.ts            # Core PDF generation with Playwright
    pdf-renderer.ts             # HTML rendering from report pages
    pdf-templates.ts            # PDF template definitions
    pdf-headers-footers.ts      # Header/footer generation

app/
  api/
    reports/
      [id]/
        export/
          pdf/
            route.ts            # PDF export API endpoint
  components/
    editor/
      PDFExportButton.tsx       # Export UI component
  styles/
    pdf-print.css               # Print-optimized CSS
```

### Data Flow

```
User clicks Export PDF
  ↓
PDFExportButton.tsx
  ↓
API: GET /api/reports/[id]/export/pdf
  ↓
Fetch report with pages from database
  ↓
For each page:
  - Render to HTML using pdf-renderer.ts
  - Apply PDF template (headers, footers, watermarks)
  ↓
Generate PDF using Playwright (pdf-generator.ts)
  ↓
Return PDF as download
  ↓
Create export record in database
```

## Troubleshooting

### PDF Generation Fails

1. **Check Playwright Installation**:
   ```bash
   npx playwright install chromium
   ```

2. **Check Browser Access**:
   - Ensure Playwright can access Chromium
   - Check file permissions

3. **Check Logs**:
   - Review server logs for error messages
   - Check browser console for client-side errors

### Images Not Appearing in PDF

- Ensure images are accessible (public URLs or base64)
- Check image URLs in report data
- Verify image loading in HTML before PDF generation

### Page Breaks Not Working

- Check `pdf-print.css` for proper page break CSS
- Verify page break classes are applied
- Test with different browsers

### Watermark Not Showing

- Check `includeWatermark` parameter is set to `true`
- Verify watermark CSS is included in generated HTML
- Check watermark opacity settings

## Performance Considerations

1. **Large Reports**: PDF generation can be slow for reports with many pages or images
   - Consider background job processing for large exports
   - Implement progress indicators
   - Cache generated PDFs if needed

2. **Memory Usage**: Playwright browser instances use memory
   - Browser instances are reused (singleton pattern)
   - Instances are cleaned up after use

3. **Concurrent Exports**: Multiple simultaneous exports may strain resources
   - Consider rate limiting
   - Implement queue system for production

## Future Enhancements

1. **Persistent Storage**: Save PDFs to filesystem/S3
2. **Background Processing**: Async PDF generation with status updates
3. **Custom Templates**: User-defined PDF templates
4. **Batch Export**: Export multiple reports at once
5. **Email Integration**: Email PDFs directly
6. **Digital Signatures**: Add signature support to PDFs

## Testing

### Manual Testing

1. Create a test report with multiple pages
2. Add images to test image rendering
3. Test with different categories to verify template selection
4. Test watermark and branding options
5. Test page selection feature
6. Verify page numbering works correctly

### Test Cases

- [ ] Export single page report
- [ ] Export multi-page report
- [ ] Export with images
- [ ] Export with watermark
- [ ] Export without branding
- [ ] Export specific pages
- [ ] Verify headers and footers
- [ ] Verify page numbering
- [ ] Test all report categories

## Support

For issues or questions:
- Check server logs for errors
- Review this documentation
- Check GitHub issues
- Contact development team

---

**Last Updated**: 2025-01-27
**Version**: 1.0.0

